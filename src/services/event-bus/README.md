# Event Bus 事件总线服务

## 模块职责
本模块提供应用内部统一的事件通信机制。它实现了发布-订阅 (Publish-Subscribe) 模式，允许应用的不同模块之间进行松耦合的异步通信。

## 核心功能
-   **事件发布 (Emit/Publish)**: 任何模块都可以发布（触发）一个事件。
-   **事件订阅 (On/Subscribe)**: 模块可以订阅它们感兴趣的特定类型的事件。
-   **事件路由 (Routing)**: 确保发布的事件被准确地传递给所有相关的订阅者。
-   **监听器管理 (Listener Management)**: 管理事件监听器的注册、注销，并返回取消订阅的函数。
-   **事件类型支持**: 支持应用中定义的各类事件，如领域事件 (来自 `core/`)、系统事件等。具体事件类型定义在 `models/events/` 目录下。

## 文件结构
```typescript
event-bus/
├── README.md         // 本文档
├── event-emitter.ts  // 事件发射器的核心实现 (原 emitter.ts)
├── event-types.ts    // 可能包含事件总线自身相关的类型或常量 (原 types.ts)
├── middleware-support.ts// 事件处理中间件的支持逻辑 (原 middleware.ts)
└── event-logger.ts   // 事件日志记录的特定实现或中间件 (原 logger.ts)
└── index.ts          // 统一导出服务接口和实例
```

## 事件系统设计概述
-   **核心接口**: 事件总线通常提供以下核心方法：
    *   `emit(event: IBaseEvent)`: 用于发布一个事件。
    *   `on(eventType: string, handler: Function)`: 用于订阅指定类型的事件，并提供一个处理函数。返回一个取消订阅的函数。
    *   `off(eventType: string, handler: Function)`: 用于取消特定的事件订阅。
    *   `once(eventType: string, handler: Function)`: 订阅一次性事件。
-   **事件对象**: 传递的事件对象遵循 `models/events/base-event.ts` 中定义的 `IBaseEvent` (或其派生接口如 `IDomainEvent`, `ISystemEvent`) 结构。
-   **中间件 (Optional)**: 可能支持中间件机制，允许在事件发布或处理流程中注入自定义逻辑，如日志记录、事件验证、性能监控或错误捕获。

## 关键设计考量

### 性能与异步处理
-   支持异步事件处理器 (`async handler`)。
-   事件处理通常是异步执行的，以避免阻塞事件发布者或事件总线本身。
-   应考虑并发控制，避免因大量事件或耗时处理器导致性能问题。
-   错误隔离：单个事件处理器的错误不应影响其他处理器的执行。

### 内存管理
-   确保正确管理事件监听器的生命周期，尤其是在组件销毁或模块卸载时，必须取消相应的订阅，以防止内存泄漏。
-   对于需要保留的事件历史记录（如用于调试），应有明确的限制和清理策略。

### 错误处理
-   **处理器错误**: 事件总线应能捕获并处理在事件处理器内部抛出的异常，避免整个应用崩溃。通常会记录错误，并可能通知错误处理服务。
-   **无效事件**: 对于不符合预定义格式或类型的事件，可以选择记录错误并丢弃，或通过特定的错误事件通知系统。
-   **订阅/取消订阅错误**: 处理在订阅或取消订阅过程中可能发生的错误。

## 与其他模块的关系
-   **事件来源 (Producers/Emitters)**:
    -   `core/*`: 核心业务模块（如 tracking, sync, lifecycle）是主要的领域事件生产者。
    -   `services/chrome-api/`: 可能将底层的浏览器事件转换为应用内部事件并发布。
    -   其他服务或 UI 组件也可能发布事件。
-   **事件消费者 (Consumers/Subscribers)**:
    -   几乎所有模块都可以根据需要订阅和处理事件。
    -   例如，UI 组件 (`entrypoints/*`) 可能订阅事件以更新视图，分析模块 (`core/analytics`) 可能订阅追踪事件进行处理。
-   **依赖**:
    -   `models/events/`: 强依赖此目录定义的标准事件接口和类型。
    -   `shared/utils/`: 可能使用日志记录、错误处理等通用工具。
