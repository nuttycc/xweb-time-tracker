# Validators 数据验证服务

## 模块职责
本模块提供统一的数据验证服务，核心职责是确保应用中处理的数据（包括用户输入、API 参数、配置数据、数据库记录等）的完整性、格式正确性和有效性。

## 功能范围
-   **核心验证能力**:
    *   **配置验证**: 校验用户配置数据（如 `UserConfiguration`）是否符合预定义的格式和业务约束。
    *   **数据验证**: 校验存储在数据库中的数据（如 `EventLogRecord`, `AggregatedStatsRecord`）是否满足其模式定义和完整性要求。
    *   **输入验证**: 对来自用户界面或内部 API 的输入参数进行验证。
    *   **业务规则验证**: (如果适用) 执行与特定业务逻辑相关的复杂验证规则。
-   **支持的验证类型**:
    *   **类型检查**: 验证数据是否为预期的基础类型（如 string, number, boolean）。
    *   **格式验证**: 校验字符串格式（如 email, URL, UUID）、正则表达式匹配等。
    *   **范围与约束**: 检查数值是否在允许范围内、字符串长度是否符合要求、数组大小等。
    *   **枚举值验证**: 确保值属于预定义的有效选项集合。
    *   **自定义业务验证**: 支持通过自定义函数实现特定的业务校验逻辑。

## 文件结构
```typescript
validators/
├── README.md             // 本文档
├── config-validator.ts   // 针对配置数据的验证器 (原 config.ts)
├── data-validator.ts     // 针对持久化数据的验证器 (原 data.ts)
├── input-validator.ts    // 针对API/用户输入的验证器 (原 input.ts)
├── business-validator.ts // (可选) 针对特定业务规则的验证器 (原 business.ts)
├── schema-based-validator.ts // (可能) 基于JSON Schema或Zod等实现的通用验证器 (原 schemas.ts 可能指这个)
└── index.ts              // 统一导出验证器接口和实现
```

## 验证器设计概述
-   **统一接口**: 验证服务通常会提供一个或多个标准化的验证器接口。这些接口定义了执行验证操作（如 `validate(data): ValidationResult`）的方法。
-   **验证结果**: 验证操作返回一个统一的结果对象，该对象明确指出验证是否通过 (`isValid: boolean`)，并在验证失败时提供详细的错误信息列表 (`errors: ValidationError[]`)。每个错误通常包含字段名、错误代码和错误消息。
-   **专用验证器**: 针对不同类型的数据（如用户配置、数据库记录），可能会有专门的验证器实现，这些验证器封装了特定于该数据类型的验证规则。
-   **规则来源**: 验证规则可以硬编码在验证器中，更推荐的做法是基于在 `models/schemas/` 中定义的模式（如 TypeScript 接口、JSON Schema 定义、Zod schema 等）动态生成或应用验证规则。

## 关键设计考量

### 错误处理与反馈
-   **标准化错误**: 提供结构化的验证错误信息，包括出错的字段、具体错误原因（错误码）和用户友好的错误消息。
-   **国际化 (i18n)**: 错误消息应支持国际化，以便向不同语言的用户显示。
-   **批量错误**: 一次验证操作应能返回所有校验失败的错误，而非仅第一个错误。

### 性能与效率
-   **异步验证**: 对于可能涉及 I/O 操作（如查询数据库进行唯一性校验）的复杂验证，应支持异步执行。
-   **验证缓存 (可选)**: 对于不经常变化且验证成本较高的数据，可以考虑缓存验证结果。
-   **批量验证**: 提供对数据集合进行批量验证的能力，并优化其性能。
-   **短路验证 (Fail-Fast)**: 在某些场景下，可能需要在第一个验证错误发生时立即停止后续验证。

## 与其他模块的关系
-   **服务对象 (被依赖)**:
    -   `core/*`: 核心业务逻辑层在处理数据前，会使用验证服务确保数据有效性。
    -   `services/database/`: 在数据写入数据库前，可能会使用验证服务校验数据是否符合模式。
    -   `entrypoints/*` 或 API 处理层: 在接收用户输入或 API 请求时，使用验证服务校验参数。
-   **依赖**:
    -   `models/schemas/`: 强依赖此目录中定义的各种数据模式作为验证规则的来源。
    -   `shared/config/`: 可能依赖共享配置中的某些验证参数或开关。
    -   `shared/utils/`: 可能使用通用的错误处理或国际化工具。
    -   第三方验证库 (如 Zod, Ajv for JSON Schema)。
