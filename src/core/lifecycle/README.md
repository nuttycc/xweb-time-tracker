# Lifecycle 数据生命周期核心模块

## 模块职责
本模块负责管理原始追踪事件日志的整个生命周期，核心目标是实现用户可配置的数据保留策略，并在数据分析需求与用户隐私保护之间取得平衡。

## 核心功能
-   **保留策略管理**：提供并管理多种数据保留时长选项，例如：
    *   聚合后立即删除（最大化隐私，最小化存储）。
    *   保留短期（如7天），用于近期数据分析。
    *   保留长期（如90天），用于趋势分析。
    *   永久保留（用户需明确选择）。
-   **自动数据清理**：根据当前生效的保留策略，定期自动清理已过期的原始事件数据。
-   **策略变更处理**：响应用户对数据保留策略的动态调整，并执行相应的数据清理或保留逻辑。
-   **存储空间管理**：监控浏览器存储配额的使用情况，并在接近或达到上限时采取预警或自动清理措施。

## 文件结构
```typescript
lifecycle/
├── README.md           // 本文档
├── retention-manager.ts // 负责保留策略的逻辑与应用 (原 retention.ts)
├── data-cleanup.ts     // 负责数据清理的执行与协调 (原 cleanup.ts)
├── policy-migrator.ts  // 处理数据迁移或策略变更相关的任务 (原 migration.ts)
└── storage-monitor.ts  // 监控存储配额并处理相关逻辑 (原 quota.ts)
```

## 关键业务规则与流程

### 数据保留与清理
-   **策略驱动**：所有清理操作均基于用户设定的保留策略。
-   **聚合优先**：通常情况下，只清理已被成功聚合到统计数据中的原始事件。
-   **定期执行**：清理任务会定期自动触发。
-   **策略变更响应**：
    *   当保留期缩短时，可能需要用户确认，并异步执行数据清理。
    *   当保留期延长时，通常无需特殊操作。
-   **清理协调**：在执行大规模清理任务时，可能会协调暂停数据聚合等相关任务，以保证数据一致性。

### 存储配额管理
-   **监控**：持续监控 IndexedDB 等存储机制的已用空间和可用配额。
-   **预警**：当存储空间接近上限时，向用户发出预警。
-   **自动响应策略**（分级处理）：
    1.  **自动清理**：尝试根据保留策略（可能是临时采用更严格的策略）自动清理部分数据。
    2.  **暂停记录**：若清理无效或空间依然不足，可能暂停新的数据记录，并通知用户。
    3.  **用户引导**：引导用户手动管理数据或调整保留策略。

### 数据安全与完整性
-   **删除前验证**：确保待删除的数据确实符合清理条件（如已被聚合、无重要依赖）。
-   **有限恢复**：可能提供有限的误删数据恢复能力或策略回滚机制（具体实现复杂度较高，需谨慎评估）。

## 与其他模块的关系
-   **依赖（配置）**：
    -   `core/sync/`: 用户配置（包含保留策略）的变更可能通过同步模块触发本模块的策略更新。
-   **依赖（服务）**：
    -   `services/database/`: 调用数据库服务执行实际的数据查询和删除操作。
-   **协调与交互**：
    -   `core/analytics/`: 在数据清理期间，可能需要与数据分析模块协调，如暂停或恢复数据聚合任务。
