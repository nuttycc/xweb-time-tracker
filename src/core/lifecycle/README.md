# Lifecycle 数据生命周期核心模块

## 模块职责
负责原始事件日志的生命周期管理，实现用户可控的数据保留策略，平衡数据分析需求与隐私保护。

## 功能范围

### 核心功能
- **保留策略管理**：支持多种数据保留时长选项
- **自动清理**：根据策略自动清理过期数据
- **策略变更处理**：响应用户保留策略的动态调整
- **存储配额管理**：监控和处理存储空间限制

### 保留策略选项
1. **聚合后立即删除**：最大隐私保护，最小存储占用
2. **保留预设短期**：支持短期数据分析需求
3. **保留预设长期**：支持长期行为模式研究
4. **永久保留**：完整保留所有原始数据

## 文件结构
```
lifecycle/
├── README.md           # 本文档
├── retention.ts        # 保留策略实现
├── cleanup.ts          # 数据清理逻辑
├── migration.ts        # 数据迁移处理
└── quota.ts           # 存储配额管理
```

## 业务规则实现

### 策略变更规则
```typescript
// 伪代码示例
interface PolicyChangeRule {
  // 缩短保留期：需要用户确认 + 异步清理
  shortenRetention: {
    requireConfirmation: true;
    executionMode: 'async';
  };
  // 延长保留期：无需特殊操作
  extendRetention: {
    requireConfirmation: false;
    executionMode: 'none';
  };
}
```

### 清理协调机制
- **暂停聚合**：清理期间暂停数据聚合任务
- **批量删除**：高效的批量数据删除操作
- **进度反馈**：向用户展示清理进度
- **恢复聚合**：清理完成后恢复正常聚合

## 清理流程

### 定期清理流程
1. **策略检查**：检查当前保留策略设置
2. **过期识别**：识别超过保留期限的数据
3. **聚合验证**：确保数据已被聚合处理
4. **安全删除**：删除已聚合的过期原始数据

### 策略变更清理
1. **影响评估**：计算策略变更影响的数据范围
2. **用户确认**：展示影响范围并要求用户确认
3. **协调执行**：与聚合任务协调执行清理
4. **结果反馈**：向用户反馈清理结果

## 存储配额管理

### 配额监控
- **实时监控**：监控IndexedDB存储使用情况
- **预警机制**：接近配额限制时提前预警
- **自动响应**：配额超限时的自动处理策略

### 超限处理策略
1. **第一级（自动清理）**：自动触发数据清理，重试写入
2. **第二级（暂停记录）**：暂停新日志记录，显示通知
3. **第三级（用户引导）**：引导用户进行手动数据管理

## 数据安全保障

### 删除前验证
- **聚合状态检查**：确保数据已被正确聚合
- **依赖关系检查**：避免删除仍被引用的数据
- **备份验证**：确认聚合数据的完整性

### 恢复机制
- **误删恢复**：提供有限的误删数据恢复能力
- **策略回滚**：支持保留策略的回滚操作

## 与其他模块的关系
- **策略来源**：core/sync/（配置同步触发策略变更）
- **数据操作**：services/database/（执行实际的数据删除）
- **协调对象**：core/analytics/（协调聚合任务的暂停和恢复）
