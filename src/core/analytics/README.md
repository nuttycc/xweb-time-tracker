# Analytics 数据分析核心模块

## 模块职责
负责时间数据的聚合计算、查询逻辑和统计分析，将原始追踪事件转换为有意义的统计信息。

## 功能范围

### 核心功能
- **数据聚合**：将原始事件聚合为日、周、月统计数据
- **多层级查询**：支持主域名、主机名、具体页面的分层查询
- **实时计算**：为长期会话提供近实时的统计更新
- **数据导出**：支持统计数据的结构化导出

### 聚合规则
1. **时间维度**：按日期聚合数据（YYYY-MM-DD格式）
2. **URL维度**：支持完整URL、主机名、主域名三个层级
3. **指标计算**：分别计算打开时间和活跃时间
4. **增量更新**：支持checkpoint事件的增量聚合

## 文件结构
```
analytics/
├── README.md           # 本文档
├── aggregator.ts       # 数据聚合器
├── query.ts           # 查询逻辑
├── export.ts          # 数据导出功能
└── calculator.ts      # 统计计算逻辑
```

## 数据处理流程

### 聚合流程
1. **事件收集**：从events_log表读取未处理事件
2. **数据计算**：计算时间差值和累积统计
3. **分层聚合**：更新URL、主机名、主域名三个层级的数据
4. **持久化**：将结果写入aggregated_stats表

### 查询流程
1. **参数解析**：解析查询条件（时间范围、URL层级等）
2. **数据检索**：从aggregated_stats表查询相关数据
3. **结果组装**：按层级组织查询结果
4. **格式化输出**：返回标准化的查询结果

## 关键算法

### 主域名提取
使用PSL（Public Suffix List）库准确提取主域名：
```typescript
// 伪代码示例
function extractParentDomain(hostname: string): string {
  return psl.get(hostname) || hostname;
}
```

### 时间聚合
支持多种时间粒度的聚合计算：
- 按URL聚合：最细粒度统计
- 按主机名聚合：中等粒度统计  
- 按主域名聚合：最粗粒度统计

## 与其他模块的关系
- **输入来源**：core/tracking/（追踪事件）
- **数据存储**：services/database/（数据库操作）
- **服务对象**：entrypoints/popup/、entrypoints/options/（UI展示）
