# Analytics 数据分析核心模块

## 模块职责
本模块负责对原始追踪数据进行聚合计算、查询处理和统计分析，旨在将用户的时间追踪事件转化为有价值的、可理解的统计信息。

## 核心功能
-   **数据聚合**：将原始追踪事件按日、周、月等维度聚合成统计数据。
-   **分层查询**：支持按主域名、完整主机名以及具体页面路径进行多层级数据查询。
-   **实时性计算**：为长时间持续的会话提供近乎实时的统计数据更新。
-   **数据导出**：提供将统计数据结构化导出的能力。

## 核心业务规则
-   **时间维度聚合**：数据按日期（YYYY-MM-DD）进行聚合。
-   **URL 维度聚合**：支持完整 URL、主机名、主域名三个层级的聚合。
-   **指标计算**：分别计算并存储页面的总打开时间和总活跃时间。
-   **增量更新**：支持基于检查点（checkpoint）事件的增量式聚合，优化性能。

## 文件结构
```typescript
analytics/
├── README.md           // 本文档
├── aggregator.ts       // 负责数据聚合逻辑
├── query-engine.ts     // 负责数据查询逻辑 (假设原 query.ts 为此功能)
├── data-exporter.ts    // 负责数据导出功能 (假设原 export.ts 为此功能)
└── stats-calculator.ts // 负责核心统计计算逻辑 (假设原 calculator.ts 为此功能)
```

## 关键逻辑与处理流程

### 数据聚合流程
1.  **事件收集**：从原始事件存储中（如 `events_log` 表）读取尚未处理的追踪事件。
2.  **时间计算**：基于事件数据，计算各会话的时间差值和累积时长。
3.  **分层聚合**：按 URL、主机名、主域名三个层级更新或创建统计记录。
4.  **数据持久化**：将聚合后的统计结果写入目标存储（如 `aggregated_stats` 表）。

### 数据查询流程
1.  **参数解析**：解析用户或系统发起的查询请求（如时间范围、URL 层级、过滤条件）。
2.  **数据检索**：根据解析后的参数，从聚合统计数据存储中查询相关记录。
3.  **结果组装**：按查询要求的层级和格式组织查询结果。
4.  **格式化输出**：返回标准化的、易于消费的查询结果。

### 主域名提取
为确保统计的准确性，主域名提取采用标准库（如 Public Suffix List, PSL）进行处理。
```typescript
// 核心思想：通过PSL库获取给定主机名的有效顶级域名（eTLD+1）
function extractParentDomain(hostname: string): string {
  // const parentDomain = psl.get(hostname); // 示例：使用psl库
  // return parentDomain || hostname; // 如果无法解析，则返回原始hostname
  return "example.com"; // 简化示例
}
```

## 与其他模块的关系
-   **依赖（输入）**：
    -   `core/tracking/`: 获取原始的时间追踪事件数据。
-   **依赖（服务）**：
    -   `services/database/`: 调用数据库服务进行数据的读取和持久化。
-   **被依赖（输出）**：
    -   `entrypoints/popup/`: 为弹出页面提供统计数据展示。
    -   `entrypoints/options/`: 为选项页面提供统计数据和配置界面支持。
