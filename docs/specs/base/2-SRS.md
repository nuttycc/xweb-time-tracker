# 02-系统需求规格说明书(SRS).md

## 1. 文档信息

| 属性 | 内容 |
| :--- | :--- |
| **文档名称** | Chrome 网页时间追踪扩展 - 系统需求规格说明书 |
| **文档版本** | v2.1.0 |
| **创建日期** | 2025年6月17日 |
| **目标受众** | 系统架构师、技术负责人、测试工程师 |
| **依赖文档** | `01-产品需求文档(PRD).md` (v2.1.2) |

## 2. 文档范围与边界 (Scope and Boundaries)

本SRS文档旨在将产品需求转化为系统级的技术语言，其职责是明确定义系统“必须满足什么条件”。

**本文档包含 (In Scope):**
*   系统级功能需求：将PRD中的用户故事和业务规则分解为具体的系统功能点。
*   量化的非功能性需求 (NFRs)：为性能、可靠性、安全等提供明确、可测试的技术指标。
*   外部接口与依赖：定义系统与外部环境（如浏览器API）的交互契约和依赖关系。
*   系统级约束：明确在技术实现层面必须遵守的限制和条件。

**本文档不包含 (Out of Scope):**
*   业务价值与用户故事：这些属于上游PRD文档的内容。
*   高级架构方案：系统的整体架构图、模块划分等将在《高级设计文档 (HLD)》中定义。
*   具体实现细节：任何关于“如何做”的详细算法、类设计或数据库模式。

## 3. 系统概述
本系统是一个作为Chrome浏览器扩展运行的时间追踪工具。它必须能够在本地、可靠地记录用户在网页上的“打开时间”和“活跃时间”两个核心指标。系统需要通过监听浏览器事件，并应用“单一焦点”和“情景感知”的计时规则，来确保数据的准确性。系统还必须支持用户配置的跨设备同步、基于策略的数据生命周期管理和长期会话的进度保障机制。

## 4. 功能性需求

### SYS-FR-1: 时间追踪引擎
1.  **SYS-FR-1.1**: 系统必须实现“单一焦点”原则，在任何时刻，仅将当前激活的标签页作为计算“活跃时间”的唯一候选。
2.  **SYS-FR-1.2**: 系统必须能够检测焦点标签页的媒体播放状态，以区分“主动交互”和“被动媒体消费”两种专注情景。
3.  **SYS-FR-1.3**: 系统必须能够处理URL的规范化，包括移除`www`前缀和基于公共后缀列表（PSL）进行主域名提取。
4.  **SYS-FR-1.4**: 系统必须能够根据预定义的列表，过滤URL中的营销跟踪参数和浏览器内部页面。
5.  **SYS-FR-1.5**: 系统必须能够可靠地检测单页应用（SPA）中的客户端路由变化。
6.  **SYS-FR-1.6**: 系统必须实现一个周期性任务调度器，能够为长期会话创建进度检查点（checkpoint）。
7.  **SYS-FR-1.7**: 系统必须能够检测`Open Time`和`Active Time`的持续时长，并在超过预设阈值时触发checkpoint创建。
8.  **SYS-FR-1.8**: checkpoint事件的生成必须能够触发即时的增量数据聚合，以确保长期会话数据的实时可见性。

### SYS-FR-2: 数据持久化
1.  **SYS-FR-2.1**: 系统必须使用一个客户端数据库，该数据库需能够存储和高效查询大量的结构化历史数据。
2.  **SYS-FR-2.2**: 系统必须使用一个高性能的本地键值存储机制，用于持久化保存非同步的、易变的实时会话状态。
3.  **SYS-FR-2.3**: 系统的数据记录过程必须具备对意外中断（如Service Worker终止）的恢复能力，确保已捕获的事件在被永久化存储前不会丢失。
4.  **SYS-FR-2.4**: 系统必须在启动时执行一个恢复流程，能识别并妥善处理因浏览器崩溃而产生的“孤儿会话”。
5.  **SYS-FR-2.5**: 聚合子系统必须能够识别并处理`checkpoint`事件，确保长期会话数据的实时可见性。
6.  **SYS-FR-2.6**: 系统必须实现数据清理与数据聚合的协调机制，确保清理操作不影响正在进行的聚合任务。

### SYS-FR-3: 数据查询与分析
1.  **SYS-FR-3.1**: 系统必须提供一个接口，支持按预设及自定义时间范围查询统计数据。
2.  **SYS-FR-3.2**: 查询结果必须能够同时提供`Open Time`和`Active Time`两个指标。
3.  **SYS-FR-3.3**: 系统必须支持一个分层的数据聚合逻辑，允许数据从主域名、到主机名、再到完整URL路径进行逐级展示。

### SYS-FR-4: 数据管理系统
#### SYS-FR-4A: 用户配置管理
1.  **SYS-FR-4A.1**: 系统必须提供用户配置的跨设备同步能力。
2.  **SYS-FR-4A.2**: 系统必须实现`PRD`中定义的“整体覆盖+用户透明”的冲突处理策略。
3.  **SYS-FR-4A.3**: 系统必须提供用户界面，展示配置的最后同步时间和来源设备，并在配置被覆盖时提供明确通知。
4.  **SYS-FR-4A.4**: 系统必须支持用户配置的手动导出和导入功能。

#### SYS-FR-4B: 原始日志管理
1.  **SYS-FR-4B.1**: 系统必须实现一个数据清理引擎，该引擎能够根据用户设定的保留策略自动执行清理任务。
2.  **SYS-FR-4B.2**: 当用户将保留策略变更为一个更短的周期时，系统必须执行一次性清理任务，并在此之前获得用户的明确确认。
3.  **SYS-FR-4B.3**: 系统必须提供原始事件日志的手动导出功能。

#### SYS-FR-4C: 统计数据备份
1.  **SYS-FR-4C.1**: 系统必须提供将本地聚合统计数据导出为结构化JSON文件的功能。
2.  **SYS-FR-4C.2**: 系统必须支持导入符合格式规范的JSON文件，并能够处理数据冲突。
3.  **SYS-FR-4C.3**: 聚合数据的冲突合并逻辑必须基于记录的`last_updated`元数据来保留最新版本。

## 5. 非功能性需求 (NFRs)

### NFR-1: 性能
1.  **NFR-1.1 (查询响应)**: `SYS-FR-3`中定义的基础数据查询，其95百分位（P95）响应时间必须小于**500毫秒**。
2.  **NFR-1.2 (后台处理)**: 后台数据聚合任务运行时，扩展的CPU峰值占用率不应超过单核资源的**10%**。
3.  **NFR-1.3 (配置响应)**: `SYS-FR-4A`中定义的用户配置变更，其应用和同步必须在**5秒**内开始执行。
4.  **NFR-1.4 (清理效率)**: `SYS-FR-4B`中定义的数据清理任务，其执行期间的CPU占用率不应超过单核资源的**5%**。

### NFR-2: 可靠性
1.  **NFR-2.1 (存储管理)**: 当本地存储使用量超过其总配额的80%时，系统必须向用户发出存储空间预警。
2.  **NFR-2.2 (存储超限)**: 当遭遇存储配额超限错误时，系统必须立即暂停新数据的写入，并持久化地通知用户进行数据管理。
3.  **NFR-2.3 (恢复效率)**: `SYS-FR-2.4`中定义的崩溃恢复流程，其执行时间必须在浏览器启动后的**5秒**内完成。
4.  **NFR-2.4 (配置持久性)**: 用户配置数据必须被持久化存储，并在系统重启或跨设备同步后保持有效。
5.  **NFR-2.5 (清理安全性)**: 数据清理操作必须具备事务性或幂等性，确保在中断后不会导致数据状态不一致。

### NFR-3: 安全性
1.  **NFR-3.1 (数据隐私)**: 系统在任何情况下都不得将用户数据传输到任何外部服务器。
2.  **NFR-3.2 (数据清理)**: 从外部（如导入文件）接收的数据在写入数据库前，必须经过安全清理（Sanitization）流程。

## 6. 外部接口与依赖
1.  **DEP-1 (Chrome Extension APIs)**: 系统将深度依赖以下Chrome扩展API族：`chrome.tabs`, `chrome.webNavigation`, `chrome.storage`, `chrome.alarms`。
2.  **DEP-2 (Public Suffix List)**: 为实现`SYS-FR-1.3`中定义的精准域名聚合，系统必须依赖一个公共后缀列表（PSL）的实现或数据源。
3.  **DEP-3 (用户配置存储)**: 系统必须依赖支持跨设备同步的存储机制（如`chrome.storage.sync`）进行用户配置的持久化。
4.  **DEP-4 (会话状态存储)**: 系统必须依赖高性能的本地存储机制（如`chrome.storage.local`）来持久化实时会话状态。

## 7. 约束条件
1.  **CON-1 (平台约束)**: 系统必须作为Chrome浏览器扩展运行，其所有功能都必须在Manifest V3的安全策略下实现。
2.  **CON-2 (业务约束)**: 系统必须以开源项目的形式存在，且不得包含任何形式的广告或商业推广内容。

---
