# æ ¸å¿ƒé€»è¾‘ä»»åŠ¡è®¡åˆ’: ç¬¬å››é˜¶æ®µ - å‰ä¸‰é˜¶æ®µé›†æˆéªŒè¯æµ‹è¯• - v2.0

çŠ¶æ€: ğŸ“‹ æ­£å¼æ–¹æ¡ˆ

## èŒƒå›´ (Scope)

**ä»…åŒ…å« (ONLY INCLUDE)**:

- **å‰ä¸‰é˜¶æ®µå®Œæ•´éªŒè¯**: å¯¹Stage 1-3 (æ•°æ®åº“æ¨¡å—ã€èšåˆæ¨¡å—ã€æ—¶é—´è¿½è¸ªæ¨¡å—) è¿›è¡Œç«¯åˆ°ç«¯é›†æˆéªŒè¯
- **çœŸå®æµè§ˆå™¨ç¯å¢ƒæµ‹è¯•**: ä½¿ç”¨Playwrightåœ¨çœŸå®Chromeæµè§ˆå™¨ä¸­åŠ è½½æ‰©å±•è¿›è¡Œæµ‹è¯•
- **æ¨¡å—åä½œéªŒè¯**: éªŒè¯ä¸‰ä¸ªæ ¸å¿ƒæ¨¡å—é—´çš„æ•°æ®æµå’Œåä½œæ­£ç¡®æ€§
- **å¼‚å¸¸æ¢å¤éªŒè¯**: æµ‹è¯•ç³»ç»Ÿåœ¨å„ç§å¼‚å¸¸æƒ…å†µä¸‹çš„æ¢å¤èƒ½åŠ›

**æ˜ç¡®æ’é™¤ (Explicitly EXCLUDE)**:

- **ç”¨æˆ·ç•Œé¢ (UI/UX) æµ‹è¯•**: ä¸æ¶‰åŠPopupã€Optionsé¡µé¢ç­‰UIç»„ä»¶æµ‹è¯•
- **æ€§èƒ½åŸºå‡†æµ‹è¯•**: ä¸“æ³¨åŠŸèƒ½æ­£ç¡®æ€§éªŒè¯ï¼Œä¸è¿›è¡Œæ€§èƒ½ä¼˜åŒ–
- **è·¨æµè§ˆå™¨å…¼å®¹æ€§**: ä»…é’ˆå¯¹Chromeæµè§ˆå™¨ç¯å¢ƒ

## æŠ€æœ¯ç­–ç•¥

### æ ¸å¿ƒå†³ç­–: Playwright + çœŸå®æµè§ˆå™¨ç¯å¢ƒ

é€‰æ‹©Playwrightä½œä¸ºæµ‹è¯•æ¡†æ¶çš„å…³é”®åŸå› :
- **çœŸå®ç¯å¢ƒ**: åœ¨çœŸå®Chromeæµè§ˆå™¨ä¸­è¿è¡Œï¼Œå®Œæ•´æ”¯æŒæ‰©å±•API
- **APIå®Œæ•´æ€§**: æ”¯æŒæ‰€æœ‰chrome.*æ‰©å±•APIå’Œæµè§ˆå™¨è¡Œä¸º
- **å¯é æ€§**: æ¶ˆé™¤fake-browserç¯å¢ƒçš„å±€é™æ€§å’Œå‡é˜³æ€§é—®é¢˜
- **è°ƒè¯•å‹å¥½**: å¯è§†åŒ–è°ƒè¯•å’Œè¯¦ç»†é”™è¯¯æŠ¥å‘Š

## ä»»åŠ¡ (Tasks)

### é˜¶æ®µ1ï¼šæµ‹è¯•ç¯å¢ƒæ­å»ºä¸åŸºç¡€è®¾æ–½ âœ… **å·²å®Œæˆ**

- [x] **1. Playwrightç¯å¢ƒé…ç½®** âœ…
  - [x] å®‰è£…Playwrightæµ‹è¯•æ¡†æ¶å’ŒChromeæµè§ˆå™¨æ”¯æŒ
  - [x] é…ç½®æ‰©å±•åŠ è½½æœºåˆ¶ï¼Œæ”¯æŒåœ¨æµ‹è¯•ä¸­åŠ¨æ€åŠ è½½æ„å»ºçš„æ‰©å±•
  - [x] è®¾ç½®æµ‹è¯•é…ç½®æ–‡ä»¶ï¼ŒåŒ…æ‹¬è¶…æ—¶ã€é‡è¯•ã€å¹¶å‘æ§åˆ¶ç­‰å‚æ•°

- [x] **2. æµ‹è¯•è¾…åŠ©å·¥å…·å¼€å‘** âœ…
  - [x] åˆ›å»ºæ‰©å±•æ•°æ®åº“è®¿é—®å·¥å…·ï¼Œèƒ½å¤Ÿç›´æ¥è¯»å–IndexedDBä¸­çš„äº‹ä»¶å’Œç»Ÿè®¡æ•°æ®
  - [x] å¼€å‘æµè§ˆå™¨çŠ¶æ€ç®¡ç†å·¥å…·ï¼Œç”¨äºæ¨¡æ‹Ÿæ ‡ç­¾é¡µæ“ä½œå’Œçª—å£ç„¦ç‚¹å˜åŒ–
  - [x] å®ç°ç”¨æˆ·äº¤äº’æ¨¡æ‹Ÿå·¥å…·ï¼Œæ”¯æŒé¼ æ ‡ã€é”®ç›˜ã€æ»šåŠ¨ç­‰äº¤äº’äº‹ä»¶
  - [x] å»ºç«‹æµ‹è¯•æ•°æ®éªŒè¯å·¥å…·ï¼Œæä¾›æ•°æ®ä¸€è‡´æ€§å’Œå®Œæ•´æ€§æ£€æŸ¥

- [x] **3. æµ‹è¯•ç›®å½•ç»“æ„å»ºç«‹** âœ…
  - [x] åˆ›å»ºä¸“ç”¨çš„é›†æˆæµ‹è¯•ç›®å½•ç»“æ„
  - [x] å»ºç«‹æµ‹è¯•ç”¨ä¾‹åˆ†ç±»å’Œå‘½åè§„èŒƒ
  - [x] è®¾ç½®æµ‹è¯•æ•°æ®å’Œé…ç½®æ–‡ä»¶ç®¡ç†
  - [x] é…ç½®æµ‹è¯•æŠ¥å‘Šå’Œæ—¥å¿—è¾“å‡ºæ ¼å¼

**é˜¶æ®µ1å®æ–½å®Œæˆè¯´æ˜**ï¼š
- **å®æ–½æ—¥æœŸ**: 2025-06-30
- **å®æ–½æ–‡ä»¶**: å®Œæ•´çš„ `tests/e2e/` ç›®å½•ç»“æ„å·²å»ºç«‹
- **æ ¸å¿ƒç»„ä»¶**:
  - 4ä¸ªæµ‹è¯•è¾…åŠ©å·¥å…· (`helpers/`)
  - æµ‹è¯•æ•°æ®å·¥å‚å’Œé…ç½®ç®¡ç† (`fixtures/`)
  - åŸºç¡€æµ‹è¯•ç±»å’Œæ‰©å±•åŠ è½½å™¨ (`utils/`)
  - å…¨å±€è®¾ç½®å’Œæ¸…ç†æœºåˆ¶ (`global-setup.ts`, `global-teardown.ts`)
- **éªŒè¯çŠ¶æ€**: é€šè¿‡TypeScriptç¼–è¯‘æ£€æŸ¥å’ŒåŸºç¡€åŠŸèƒ½éªŒè¯
- **è¯¦ç»†æŠ¥å‘Š**: å‚è§ `tests/e2e/IMPLEMENTATION_REPORT.md`

### é˜¶æ®µ2ï¼šæ ¸å¿ƒé›†æˆæµ‹è¯•ç”¨ä¾‹å®ç°

- [ ] **1. å®Œæ•´æ•°æ®æµéªŒè¯æµ‹è¯•**

  - [ ] **1.1 open_time æ—¶é—´è¿½è¸ªæµ‹è¯•**
    - Step 1: åˆ›å»ºæ–° tab 1 å¹¶è®¿é—®ä¸€ä¸ª URL 1ï¼Œå¦‚ `https://www.github.com` 
      -> éªŒè¯ eventslog è¡¨ä¸­ç”Ÿæˆ `open_time_start` äº‹ä»¶
    - Step 2: ä¿æŒ tab 1 ä¸å˜ï¼Œè®¿é—®æ–°çš„ URL 2ï¼Œå¦‚ `https://developer.mozilla.org` 
      -> éªŒè¯ eventslog è¡¨ä¸­ç”Ÿæˆ URL 1 çš„ `open_time_end` äº‹ä»¶
      -> éªŒè¯ eventlog è¡¨ä¸­ç”Ÿæˆ URL 2 çš„ `open_time_start` äº‹ä»¶

  - [ ] **1.2 active_time æ—¶é—´è¿½è¸ªæµ‹è¯•**
    - Step 1: åˆ›å»ºæ–° tab 1 å¹¶è®¿é—®ä¸€ä¸ª URL 1ï¼Œå¦‚ `https://www.github.com`ï¼Œè§¦å‘ä»»æ„ç”¨æˆ·äº¤äº’äº‹ä»¶ï¼ˆå¦‚é¼ æ ‡ç§»åŠ¨ã€é”®ç›˜è¾“å…¥ç­‰ï¼‰
      -> éªŒè¯ eventslog è¡¨ä¸­ç”Ÿæˆ `active_time_start` äº‹ä»¶
    - Step 2: ä¿æŒ tab 1 ä¸å˜ï¼Œè®¿é—®æ–°çš„ URL 2ï¼Œå¦‚ `https://developer.mozilla.org`ï¼Œæ— äº¤äº’
      -> éªŒè¯ eventslog è¡¨ä¸­ç”Ÿæˆ URL 1 çš„ `active_time_end` äº‹ä»¶
      -> éªŒè¯ eventlog è¡¨ä¸­ NO ç”Ÿæˆ URL 2 çš„ `active_time_start` äº‹ä»¶
    - Step 3: step2 éªŒè¯åï¼Œåœ¨ URL 2 é¡µé¢ä¸Šè§¦å‘ä»»æ„äº¤äº’äº‹ä»¶ï¼ˆå¦‚é¼ æ ‡ç§»åŠ¨ã€é”®ç›˜è¾“å…¥ç­‰ï¼‰
      -> éªŒè¯ eventlog è¡¨ä¸­ç”Ÿæˆ URL 2 çš„ `active_time_start` äº‹ä»¶

  - [ ] **1.3 checkpoint æµ‹è¯•**
    - å‡†å¤‡å·¥ä½œ: åœ¨æµ‹è¯•é…ç½®ä¸­å°† `checkpointScheduler` çš„ `intervalMinutes`, `activeTimeThresholdHours`, `openTimeThresholdHours` è®¾ç½®ä¸ºæå°å€¼ï¼ˆå¦‚ `intervalMinutes: 0.1`, `thresholds: 0.001` å°æ—¶ï¼‰ä»¥å¿«é€Ÿè§¦å‘ã€‚
    - Step 1 (open_time): åˆ›å»ºæ–° tab 1, è®¿é—® URL 1 å¹¶ä¿æŒæ‰“å¼€çŠ¶æ€è¶…è¿‡ `openTimeThresholdHours` é˜ˆå€¼ã€‚
      -> éªŒè¯ eventslog è¡¨ä¸­ä¸ºè¯¥ä¼šè¯ç”Ÿæˆä¸€ä¸ª `eventType: 'checkpoint'` çš„äº‹ä»¶ï¼Œå…¶ `activityId` ä¸º nullã€‚
    - Step 2 (active_time): åˆ›å»ºæ–° tab 2, è®¿é—® URL 2, è§¦å‘ç”¨æˆ·äº¤äº’ï¼Œå¹¶ä¿æŒæ´»åŠ¨çŠ¶æ€è¶…è¿‡ `activeTimeThresholdHours` é˜ˆå€¼ã€‚
      -> éªŒè¯ eventslog è¡¨ä¸­ä¸ºè¯¥ä¼šè¯ç”Ÿæˆä¸€ä¸ª `eventType: 'checkpoint'` çš„äº‹ä»¶ï¼Œå…¶ `activityId` ä¸ä¸º null ä¸”ä¸ `active_time_start` äº‹ä»¶çš„ `activityId` åŒ¹é…ã€‚

  - [ ] **1.4 æ•°æ®èšåˆæµ‹è¯•**
    - Step 1: åœ¨ `eventslog` è¡¨ä¸­æ‰‹åŠ¨æ’å…¥æˆ–é€šè¿‡æ¨¡æ‹Ÿç”¨æˆ·è¡Œä¸ºç”Ÿæˆä¸€ç»„é’ˆå¯¹ç‰¹å®š URLï¼ˆå¦‚ `https://www.google.com`ï¼‰çš„å®Œæ•´äº‹ä»¶è®°å½•ï¼Œæ—¶é—´æˆ³åˆ†å¸ƒåœ¨ä¸€æ—¥ä¹‹å†…ã€‚
      - è®°å½•1: `open_time_start` (T+0s)
      - è®°å½•2: `active_time_start` (T+10s)
      - è®°å½•3ï¼š open_time çš„ `checkpoint` äº‹ä»¶ (T+20s)
      - è®°å½•4ï¼š active_time çš„ `checkpoint` äº‹ä»¶ (T+30s)
      - è®°å½•5ï¼š open_time çš„ `checkpoint` äº‹ä»¶ (T+40s)
      - è®°å½•6ï¼š active_time çš„ `checkpoint` äº‹ä»¶ (T+50s)
      - è®°å½•7ï¼š open_time çš„ `checkpoint` äº‹ä»¶ (T+60s)
      - è®°å½•8: `active_time_end` (T+70s)
      - è®°å½•9: `open_time_end` (T+80s)
    - Step 2: æ‰‹åŠ¨è§¦å‘ `AggregationService` çš„èšåˆæµç¨‹ã€‚
    - Step 3: èšåˆå®Œæˆåï¼ŒæŸ¥è¯¢ `aggregatedstats` è¡¨ä¸­å¯¹åº”æ—¥æœŸå’Œ URL çš„è®°å½•ã€‚
      -> éªŒè¯:
        - `totalActiveTime` å­—æ®µå€¼æ˜¯å¦ä¸º 70sã€‚
        - `totalOpenTime` å­—æ®µå€¼æ˜¯å¦ä¸º 80sã€‚
        - `visitCount` å­—æ®µå€¼æ˜¯å¦ä¸º 1ã€‚




## Referencesï¼ˆå‚è€ƒï¼‰
- [Playwright å®˜æ–¹æ–‡æ¡£ - æµ‹è¯• Chrome æ‰©å±•](https://playwright.dev/docs/chrome-extensions)
- [WXT å®˜æ–¹æ–‡æ¡£ - ç«¯åˆ°ç«¯æµ‹è¯•](https://wxt.dev/guide/essentials/e2e-testing.html)