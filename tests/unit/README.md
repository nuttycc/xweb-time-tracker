# Unit Tests 单元测试

## 模块职责
本目录 (`tests/unit/`) 存放项目的所有单元测试代码。单元测试的目标是独立地验证应用中最小的可测试单元（如单个函数、类的方法、或 Vue 组件的某个特定行为）是否按预期正确工作。

## 测试原则与特征
-   **独立性 (Isolation)**: 每个单元测试应独立于其他测试运行，不应有共享状态或顺序依赖。被测单元的外部依赖通常需要被模拟 (mocked) 或存根 (stubbed)。
-   **快速性 (Speed)**: 单元测试应执行得非常快（通常在毫秒级别），以便开发者可以频繁运行它们。
-   **确定性 (Determinism)**: 给定相同的输入和相同的被测单元版本，单元测试应总是产生相同的结果。
-   **单一职责 (Focus)**: 每个测试用例通常只验证被测单元的一个特定方面、一个逻辑路径或一个功能点。
-   **测试范围**:
    *   验证函数逻辑的正确性。
    *   测试类的方法是否按预期行为。
    *   覆盖各种输入（包括有效、无效和边界值）的处理。
    *   确保错误处理机制按设计工作。
    *   验证数据转换、计算和状态变更的准确性。

## 目录结构 (示例)
```
unit/
├── README.md                // 本文档
├── core/                    // 核心业务逻辑 (src/core) 的单元测试
│   └── analytics/
│       └── aggregator.test.ts
├── services/                // 服务层 (src/services) 的单元测试
│   └── database/
│       └── EventRepository.test.ts
├── models/                  // 数据模型 (src/models) 的单元测试
│   └── entities/
│       └── TimeRecord.test.ts
└── shared/                  // 共享工具和组件 (src/shared) 的单元测试
    └── utils/
        └── time-utils.test.ts
```
*测试文件通常与被测试的源文件在结构上对应，并使用 `.test.ts` 或 `.spec.ts` 后缀。*

## 运行单元测试
```bash
# (假设已有npm script) 运行所有单元测试
npm run test:unit

# (示例) 运行特定模块的单元测试
npm run test:unit -- tests/unit/core/

# (示例) 运行单个测试文件
npm run test:unit -- tests/unit/core/analytics/aggregator.test.ts

# (示例) 以监视模式运行，在文件变更时自动重跑测试
npm run test:unit -- --watch
```

## 编写规范与最佳实践

### 核心原则
-   **Arrange-Act-Assert (AAA)**: 结构化每个测试用例：首先设置测试所需的初始条件和输入 (Arrange)，然后执行被测操作 (Act)，最后验证结果是否符合预期 (Assert)。
-   **清晰命名**: 测试文件和测试用例的描述 (`describe`, `it`) 应清晰、准确地表达被测试的内容和预期的行为。
-   **模拟依赖**: 有效使用测试框架提供的模拟功能（如 Vitest 的 `vi.fn()`, `vi.mock()`）来隔离被测单元，控制外部依赖的行为，并验证交互。避免在单元测试中使用真实的数据库、网络请求或复杂的外部服务。
-   **明确的测试数据**: 使用具体、有代表性的输入数据进行测试，避免使用随机或不确定的数据。
-   **精确断言**: 使用尽可能精确的断言来验证结果，而不是模糊的 `toBeTruthy()`。
-   **测试隔离**: 确保每个测试用例之间以及测试文件之间都是相互隔离的，一个测试的失败不应影响其他测试。使用 `beforeEach` 和 `afterEach` (或类似机制) 来设置和清理测试环境。
-   **覆盖错误和边界情况**: 除了测试正常路径（happy path），还应特别关注错误处理逻辑和边界条件的测试。

### 常见问题处理
-   **异步代码**: 使用 `async/await` 或返回 `Promise` 的方式正确处理异步操作的测试。
-   **错误抛出**: 使用测试框架提供的机制（如 `expect(...).toThrow()`) 来验证函数是否按预期抛出错误。

## 代码覆盖率
-   项目致力于实现高水平的代码覆盖率，以确保大部分代码逻辑都经过测试。
-   通过测试框架（如 Vitest 集成的 c8/istanbul）生成覆盖率报告，并定期审阅以识别未覆盖区域。

## 与其他测试的关系
-   **基石**: 单元测试是测试金字塔的基础，为更高级别的测试（如集成测试、E2E 测试）提供信心。
-   **快速反馈**: 由于执行速度快，单元测试是开发过程中获取代码质量反馈最快的方式。
-   **辅助重构**: 良好的单元测试覆盖使得代码重构更加安全，因为它们可以快速验证重构是否破坏了现有功能。
-   **文档作用**: 清晰的单元测试本身也可以作为被测单元使用方式的一种文档。
