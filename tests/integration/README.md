# Integration Tests 集成测试

## 模块职责
本目录 (`tests/integration/`) 包含应用的集成测试用例。集成测试的目的是验证多个模块、组件或服务在协同工作时是否能按预期正确交互，确保它们之间的接口、数据流和整体行为符合设计要求。

## 测试原则与特征
-   **组件协作**: 核心是测试不同部分（如服务层与数据访问层、多个核心业务模块之间）的交互。
-   **数据流验证**: 确保数据在集成的组件之间能够正确传递、转换和处理。
-   **接口契约**: 验证模块间的接口调用是否符合约定，参数和返回值是否正确。
-   **模拟真实场景**: 尽可能模拟接近真实的使用场景或业务流程，但通常不涉及完整的 UI。
-   **测试范围**:
    *   数据库操作与 Repository 层的集成。
    *   服务层内部或服务层之间的组件协作。
    *   关键业务流程的完整性（不通过 UI）。
    *   错误在模块间的传播和处理。
    *   涉及多个组件的事务一致性（如果适用）。

## 目录结构 (示例)
```
integration/
├── README.md                // 本文档
├── database/                // 数据库相关的集成测试
│   └── data-access.int.test.ts // 例如：数据访问与聚合逻辑集成测试
├── workflows/               // 核心业务流程集成测试
│   └── time-tracking-flow.int.test.ts
├── services/                // 服务层组件间的集成测试
└── index.ts                 // (可选) 统一导出或配置入口
```
*具体的测试用例位于各 `*.int.test.ts` (或其他约定后缀) 文件中。*

## 运行集成测试
```bash
# (假设已有npm script) 运行所有集成测试
npm run test:integration

# (示例) 运行特定目录下的集成测试
npm run test:integration -- tests/integration/database/
```

## 主要测试场景
-   **数据库集成**: 测试数据访问层 (Repositories) 与实际数据库（或内存数据库）的交互，包括 CRUD 操作、事务、数据聚合等涉及真实数据读写的场景。
-   **业务流程集成**: 验证跨多个业务模块（`core/` 下的子模块）的关键业务流程是否能正确执行，例如完整的时间追踪、数据聚合到统计展示的非 UI 流程。
-   **服务层集成**: 测试不同服务（`services/` 下的子模块）之间的协作，或服务与外部依赖（如模拟的 Chrome API）的集成。例如，配置同步服务与实际存储的交互。
-   **事件驱动流程**: 测试事件的发布、通过事件总线的分发以及相应处理器正确响应并完成后续操作的完整流程。

## 编写与执行要点

### 测试环境设置
-   集成测试通常需要更复杂的环境设置，可能涉及：
    *   初始化和清理测试数据库（真实的或内存中的）。
    *   模拟部分外部依赖（如 Chrome API、网络请求），但被测模块间的依赖通常使用真实实例。
    *   配置和初始化被测的多个模块/服务。

### 测试数据管理
-   需要准备能驱动被测集成流程的测试数据。
-   测试后可能需要清理产生的数据，以保证测试的幂等性。

### 模拟策略
-   与单元测试不同，集成测试倾向于使用真实的协作者（Collaborators）。
-   仅当协作者是真正的外部系统（如第三方 HTTP 服务、完整的浏览器环境）或难以在测试环境中配置时，才考虑使用模拟对象。

### 最佳实践
-   **隔离性**: 每个集成测试用例应尽可能独立，避免测试间的状态污染。测试前设置环境，测试后清理。
-   **聚焦交互**: 测试的重点是模块间的“接缝”和数据交换，而不是模块内部的细枝末节（那由单元测试覆盖）。
-   **真实性与速度的平衡**: 尽量使用真实依赖，但在必要时（如外部 API）使用稳定的模拟来提高测试速度和可靠性。
-   **错误场景**: 测试模块间错误如何传播和处理。
-   **可读性**: 测试代码应清晰地表达被集成的组件和被验证的交互点。

### 调试
-   由于涉及多个组件，调试集成测试可能更复杂。利用日志、断点和对各组件状态的检查来定位问题。

## 与其他测试的关系
-   **基于单元测试**: 集成测试的前提是参与集成的各个单元已经通过了单元测试，保证了自身逻辑的正确性。
-   **为 E2E 测试打基础**: 通过集成测试可以验证大部分非 UI 的业务流程，减少对昂贵的 E2E 测试的依赖。
-   **补充边界测试**: 集成测试主要验证正常流程下的模块协作，而边界测试则关注这些协作在极限或异常条件下的表现。
-   **性能考量**: 虽然主要目标是功能正确性，但集成测试的执行时间也可能暴露出一些性能问题，为性能测试提供线索。
