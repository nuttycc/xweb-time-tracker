# Performance Tests 性能测试

## 模块职责
本目录 (`tests/performance/`) 包含用于评估和确保应用性能的测试脚本和相关配置。性能测试旨在衡量系统在不同负载条件下的响应时间、吞吐量、资源利用率和稳定性，以识别性能瓶颈并验证是否达到预期的性能目标。

## 测试原则与特征
-   **核心特征**:
    *   **响应时间 (Response Time)**: 测量关键操作完成所需的时间。
    *   **吞吐量 (Throughput)**: 评估系统在单位时间内能处理的请求或事务数量。
    *   **资源使用 (Resource Utilization)**: 监控应用在测试过程中的内存、CPU、存储等系统资源消耗情况。
    *   **并发性能 (Concurrency)**: 测试系统在多个用户或进程同时操作时的表现。
    *   **稳定性 (Stability/Endurance)**: 验证系统在长时间持续负载下的性能表现和资源泄漏情况。
-   **主要测试范围**:
    *   关键数据库操作（查询、写入、聚合）的性能。
    *   大量数据处理（如导入、导出、批量计算）的效率。
    *   内存使用情况，识别潜在的内存泄漏。
    *   高并发场景下的系统响应和错误率。
    *   特定组件或算法的基准性能。

## 目录结构 (示例)
```
performance/
├── README.md                      // 本文档
├── database/                      // 数据库相关的性能测试脚本
│   └── query-benchmark.perf.test.ts // 例如：数据库查询基准测试
├── benchmarks/                    // 针对特定函数或算法的微基准测试
├── load-tests/                    // 负载测试脚本 (模拟预期负载)
└── stress-tests/                  // 压力测试脚本 (测试系统极限)
```
*具体的性能测试脚本位于各 `*.perf.test.ts` (或其他约定后缀) 文件中。*

## 运行性能测试
```bash
# (假设已有npm script) 运行所有性能测试
npm run test:performance

# (示例) 运行基准测试 (通常使用如 Vitest bench 功能)
npm run test:bench
```

## 关键性能指标 (KPIs)
性能测试关注以下类型的指标：
-   **响应时间**: 包括平均响应时间、中位数 (P50)、以及高百分位（如 P95, P99）响应时间，以了解典型和最坏情况下的延迟。
-   **吞吐量**: 如每秒查询数 (QPS)、每秒事务数 (TPS)，或在特定时间内完成的操作总数。
-   **资源使用**: 包括 CPU 使用率、内存占用（峰值和平均值）、磁盘 I/O、网络带宽消耗等。
-   **错误率**: 在负载条件下，操作失败的百分比。
-   **并发数**: 系统能够稳定处理的同时在线用户数或并发请求数。

## 主要性能测试类型
-   **基准测试 (Benchmark Tests)**: 对小块代码、特定函数或算法进行精确的性能测量，通常用于比较不同实现的效率或跟踪底层性能变化。
-   **负载测试 (Load Tests)**: 模拟预期的、正常到高峰的用户负载，以验证系统在这些条件下的性能表现是否满足要求。
-   **压力测试 (Stress Tests)**: 将系统推向其极限或超出预期负载，以确定其断点、瓶颈所在，并测试其在高压下的稳定性和恢复能力。
-   **内存测试 (Memory Leak Tests)**: 通过长时间运行或重复执行特定操作，监控内存使用情况，以检测是否存在内存泄漏。
-   **耐力测试 (Endurance/Soak Tests)**: 在较长时间内（如数小时或数天）持续施加中等负载，以检查系统稳定性和资源泄露问题。

## 性能测试与监控策略
-   **性能监控**: 在测试执行期间，应使用工具或自定义逻辑来收集关键性能指标。
-   **性能分析与调优**:
    *   利用性能分析工具（profilers）识别代码中的热点和瓶颈。
    *   常见的优化方向包括：数据库查询优化（索引、批量操作）、算法复杂度优化、减少不必要的计算、内存管理优化（避免泄漏、及时释放）、并发控制（如使用连接池、控制工作线程数）。
-   **设定性能基准**: 为关键操作设定明确的、可接受的性能目标（基准）。测试结果应与这些基准进行比较。
-   **测试工具**:
    *   **Vitest `bench`**: 可用于编写和执行微基准测试。
    *   **浏览器开发者工具**: 用于分析前端性能和内存使用。
    *   **Node.js 性能 API (`perf_hooks`) / `console.time`**: 用于在 Node.js 环境中测量代码执行时间。
    *   **(可选) 专用负载测试工具**: 如 k6, Artillery, JMeter (对于需要模拟大量并发用户的场景)。
-   **持续性能监控与回归检测**:
    *   将关键性能测试集成到 CI/CD 流程中。
    *   跟踪性能指标的变化趋势，及时发现性能回归。

## 与其他测试的关系
-   **功能正确性优先**: 性能测试通常在相关功能通过单元测试和集成测试，确保其逻辑正确性之后进行。
-   **指导优化**: 性能测试的结果直接指导性能优化工作。
-   **补充边界测试**: 边界测试可能揭示导致性能急剧下降的特定条件，为性能测试提供场景。
-   **影响监控策略**: 性能测试中确定的关键指标和阈值，可以为生产环境的性能监控策略提供参考。
